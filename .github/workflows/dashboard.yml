name: Dashboard Data Collector

on:
  schedule:
    # Phiên sáng: 11:35 giờ Việt Nam (UTC+7) = 04:35 UTC, thứ 2-6
    - cron: '35 4 * * 1-5'
    # Phiên chiều: 15:05 giờ Việt Nam (UTC+7) = 08:05 UTC, thứ 2-6
    - cron: '5 8 * * 1-5'
  workflow_dispatch:
    inputs:
      date:
        description: 'Ngày thu thập (YYYY-MM-DD), bỏ trống = hôm nay'
        required: false
        default: ''
      indices_start:
        description: 'Ngày bắt đầu chỉ số (YYYY-MM-DD). Mặc định: 1 năm trước'
        required: false
        default: ''
      indices_end:
        description: 'Ngày kết thúc chỉ số (YYYY-MM-DD). Mặc định: hôm nay'
        required: false
        default: ''
      session:
        description: 'Phiên thu thập: midday (sáng), eod (cuối ngày), full (tất cả)'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - midday
          - eod

permissions:
  contents: write

jobs:
  dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytz matplotlib openpyxl

      - name: Set timezone to Vietnam
        run: echo "TZ=Asia/Ho_Chi_Minh" >> $GITHUB_ENV

      - name: Determine collection date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(TZ=Asia/Ho_Chi_Minh date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Check trading day (skip weekends + VN holidays)
        id: check_day
        run: |
          DATE="${{ steps.date.outputs.date }}"
          IS_MANUAL="${{ github.event_name }}"

          # Nếu chạy thủ công (workflow_dispatch) → luôn chạy
          if [ "$IS_MANUAL" = "workflow_dispatch" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Chạy thủ công → tiếp tục."
            exit 0
          fi

          # Kiểm tra cuối tuần
          DAY_OF_WEEK=$(TZ=Asia/Ho_Chi_Minh date +%u)
          if [ "$DAY_OF_WEEK" -gt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Hôm nay là cuối tuần → bỏ qua."
            exit 0
          fi

          # Kiểm tra ngày lễ TTCK Việt Nam
          python -c "
          from scripts.vn_holidays import is_holiday
          date = '$DATE'
          if is_holiday(date):
              print(f'{date}: NGHỈ LỄ TTCK Việt Nam → bỏ qua.')
              exit(0)
          else:
              print(f'{date}: Ngày giao dịch → tiếp tục.')
              exit(1)
          " && {
            echo "skip=true" >> $GITHUB_OUTPUT
          } || {
            echo "skip=false" >> $GITHUB_OUTPUT
          }

      # ========== DETECT SESSION: MIDDAY vs EOD ==========
      - name: Detect trading session (midday / eod)
        id: session
        if: steps.check_day.outputs.skip != 'true'
        run: |
          # Nếu chạy thủ công → dùng input session (mặc định: full)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SESSION="${{ github.event.inputs.session || 'full' }}"
          else
            # Scheduled → detect từ giờ UTC hiện tại
            HOUR_UTC=$(date -u +%H)
            if [ "$HOUR_UTC" -lt 6 ]; then
              # 04:35 UTC = 11:35 VN → phiên sáng (midday)
              SESSION="midday"
            else
              # 08:05 UTC = 15:05 VN → phiên chiều (eod)
              SESSION="eod"
            fi
          fi

          echo "session=$SESSION" >> $GITHUB_OUTPUT
          echo "Phiên thu thập: $SESSION"

          # Xác định label cho commit message
          if [ "$SESSION" = "midday" ]; then
            echo "label=midday-1130" >> $GITHUB_OUTPUT
          elif [ "$SESSION" = "eod" ]; then
            echo "label=eod-1500" >> $GITHUB_OUTPUT
          else
            echo "label=full" >> $GITHUB_OUTPUT
          fi

      # ========== PHẦN 0: CÀI ĐẶT VNSTOCK PREMIUM (có cache) ==========
      # Cache thư mục .venv để tránh chạy CLI installer mỗi lần
      # (vnstock giới hạn thiết bị, mỗi lần cài = 1 thiết bị mới)
      - name: "[0] Cache premium packages"
        id: cache-venv
        if: steps.check_day.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: |
            /home/runner/.venv
            /home/runner/.vnstock
            /home/runner/.vnai
            /home/runner/.vnii
          key: vnstock-premium-${{ runner.os }}-py3.12-v1

      - name: "[0.1] Install premium packages (chỉ khi chưa có cache)"
        if: steps.check_day.outputs.skip != 'true' && steps.cache-venv.outputs.cache-hit != 'true'
        continue-on-error: true
        run: |
          echo "Cache MISS → cài đặt premium packages..."
          echo "=== [1/3] Downloading CLI installer ==="
          wget -q https://vnstocks.com/files/vnstock-cli-installer.run -O /tmp/vnstock-cli-installer.run
          chmod +x /tmp/vnstock-cli-installer.run

          echo "=== [2/3] Running installer (non-interactive) ==="
          # CLI installer interactive prompts:
          #   Language: 1 (Vietnamese, default Enter)
          #   Python version: 1 (default Enter)
          #   Venv path: empty (skip, Enter)
          #   Auth method: 2 (Nhập API Key thủ công)
          #   API key: from env var
          printf "\n\n\n2\n${VNSTOCK_API_KEY}\n" | /tmp/vnstock-cli-installer.run 2>&1

        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      - name: "[0.2] Link venv packages to system Python"
        if: steps.check_day.outputs.skip != 'true'
        run: |
          # CLI installer cài packages vào /home/runner/.venv nhưng workflow
          # dùng system Python (actions/setup-python). Thêm venv site-packages
          # vào PYTHONPATH để system Python import được vnstock_data, vnii, etc.
          # Điều này cũng fix lỗi vnai detect tier = "free" (do thiếu vnii).
          VENV_SP=$(find /home/runner/.venv/lib -name "site-packages" -type d 2>/dev/null | head -1)
          if [ -n "$VENV_SP" ] && [ -d "$VENV_SP" ]; then
            echo "PYTHONPATH=${VENV_SP}${PYTHONPATH:+:$PYTHONPATH}" >> $GITHUB_ENV
            echo "Found venv site-packages: $VENV_SP"
            echo "Cache hit: ${{ steps.cache-venv.outputs.cache-hit }}"
            ls "$VENV_SP" | grep -E "^(vnii|vnstock_data|vnstock_news|vnstock_ta|vnstock_pipeline)" || true
          else
            echo "Warning: venv site-packages not found at /home/runner/.venv"
          fi

      - name: "[0.3] Verify premium packages"
        if: steps.check_day.outputs.skip != 'true'
        continue-on-error: true
        run: |
          python -c "
          print('Package status:')
          for pkg in ['vnii', 'vnai', 'vnstock_data', 'vnstock_news', 'vnstock_ta', 'vnstock_pipeline']:
              try:
                  mod = __import__(pkg)
                  ver = getattr(mod, '__version__', 'OK')
                  print(f'  {pkg}: v{ver}')
              except ImportError:
                  print(f'  {pkg}: NOT installed')

          # Verify tier
          try:
              from vnai.beam.auth import authenticator
              tier = authenticator.get_tier(force_refresh=True)
              limits = authenticator.get_limits(tier)
              print(f'Tier: {tier} ({limits[\"min\"]} req/min)')
          except Exception as e:
              print(f'Tier check failed: {e}')
          "
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      # ========== PHẦN 1: THU THẬP DỮ LIỆU CỔ PHIẾU ==========
      - name: "[1/15] Thu thập dữ liệu cổ phiếu"
        if: steps.check_day.outputs.skip != 'true'
        continue-on-error: true
        run: |
          python scripts/daily_collector.py --date ${{ steps.date.outputs.date }} --skip-ohlcv
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 2: THU THẬP OHLCV TOP 500 CỔ PHIẾU ==========
      # Chỉ chạy phiên chiều/full (dữ liệu OHLCV cần cả ngày)
      - name: "[2/15] Thu thập OHLCV top 500 cổ phiếu vốn hóa"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_stocks.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 3: THU THẬP DỮ LIỆU CHỈ SỐ ==========
      - name: "[3/15] Thu thập 18 chỉ số thị trường + charts"
        if: steps.check_day.outputs.skip != 'true'
        continue-on-error: true
        run: |
          START_FLAG=""
          END_FLAG=""
          if [ -n "${{ github.event.inputs.indices_start }}" ]; then
            START_FLAG="--start ${{ github.event.inputs.indices_start }}"
          fi
          if [ -n "${{ github.event.inputs.indices_end }}" ]; then
            END_FLAG="--end ${{ github.event.inputs.indices_end }}"
          fi
          python scripts/collect_indices.py $START_FLAG $END_FLAG
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 4: GIÁ VÀNG + TỶ GIÁ + COMPANY DATA ==========
      - name: "[4/15] Thu thập giá vàng, tỷ giá, company data, events, insider"
        if: steps.check_day.outputs.skip != 'true'
        continue-on-error: true
        run: |
          python scripts/collect_extras.py --date ${{ steps.date.outputs.date }}
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 5: FX + CRYPTO + WORLD INDICES + FUND ==========
      # Chỉ chạy phiên chiều/full
      - name: "[5/15] Thu thập FX, Crypto, World Indices, Fund, Listing"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_market.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 6: GIÁ HÀNG HÓA (vnstock_data) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[6/15] Thu thập giá hàng hóa (CommodityPrice)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_commodity.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 7: DỮ LIỆU VĨ MÔ (vnstock_data) ==========
      # Chỉ chạy phiên chiều/full (macro không thay đổi trong ngày)
      - name: "[7/15] Thu thập dữ liệu vĩ mô (Macro)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_macro.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 8: MARKET INSIGHTS (vnstock_data Market + TopStock) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[8/15] Thu thập thống kê thị trường (Market Insights)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_insights.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 9: TIN TỨC TÀI CHÍNH (vnstock_news) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[9/15] Thu thập tin tức tài chính (vnstock_news)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_news.py --limit 50
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      # ========== PHẦN 10: CHỈ BÁO KỸ THUẬT (vnstock_ta) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[10/15] Tính chỉ báo kỹ thuật (vnstock_ta)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_ta.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 11: PIPELINE SONG SONG (vnstock_pipeline) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[11/15] Pipeline tải OHLCV song song (vnstock_pipeline)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_pipeline.py --only ohlcv --top-n 200 --max-workers 2
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 12: INTRADAY (KBS Quote) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[12/15] Thu thập dữ liệu intraday (KBS Quote.intraday)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_intraday.py --top-n 50
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 13: COMPANY EXTRA (Reports, Ownership, Capital History) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[13/15] Thu thập company data bổ sung (reports, ownership, capital)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_company_extra.py --top-n 50
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 14: TRADING DETAIL (Foreign, Prop, Stats) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[14/15] Thu thập giao dịch chi tiết (foreign/prop trade, stats)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_trading_detail.py --top-n 50
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== PHẦN 15: FINANCE EXTRA (VCI notes/ratios + MAS) ==========
      # Chỉ chạy phiên chiều/full
      - name: "[15/15] Thu thập tài chính bổ sung (VCI notes + MAS)"
        if: steps.check_day.outputs.skip != 'true' && steps.session.outputs.session != 'midday'
        continue-on-error: true
        run: |
          python scripts/collect_finance_extra.py --top-n 50
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}
          VNSTOCK_RATE_LIMIT: '500'

      # ========== HIỂN THỊ KẾT QUẢ ==========
      - name: Show collected files
        if: steps.check_day.outputs.skip != 'true'
        run: |
          echo "=========================================="
          echo "  PHIÊN: ${{ steps.session.outputs.session }} | NGÀY: ${{ steps.date.outputs.date }}"
          echo "=========================================="
          echo ""
          echo "=========================================="
          echo "  DỮ LIỆU CỔ PHIẾU (${{ steps.date.outputs.date }})"
          echo "=========================================="
          if [ -d "data/${{ steps.date.outputs.date }}" ]; then
            ls -lh data/${{ steps.date.outputs.date }}/
          else
            echo "Không có thư mục data."
          fi
          echo ""
          echo "=========================================="
          echo "  OHLCV TOP 500 CỔ PHIẾU"
          echo "=========================================="
          ls data/stocks/*.csv 2>/dev/null | wc -l | xargs -I{} echo "{} files"
          echo ""
          echo "=========================================="
          echo "  DỮ LIỆU CHỈ SỐ (18 indices)"
          echo "=========================================="
          ls -lh data/indices/*.csv 2>/dev/null || echo "No CSV files"
          echo ""
          echo "=========================================="
          echo "  DỮ LIỆU BỔ SUNG"
          echo "=========================================="
          ls -lh data/gold_prices.csv data/exchange_rates.csv data/company_overview.csv data/company_ratios.csv 2>/dev/null || echo "No extra files"
          ls -lh data/company_events.csv data/insider_trading.csv data/shareholders.csv 2>/dev/null || echo "No company detail files"
          echo ""
          echo "=========================================="
          echo "  FX / CRYPTO / WORLD INDICES"
          echo "=========================================="
          ls data/fx/*.csv 2>/dev/null | wc -l | xargs -I{} echo "FX: {} pairs"
          ls data/crypto/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Crypto: {} coins"
          ls data/world_indices/*.csv 2>/dev/null | wc -l | xargs -I{} echo "World: {} indices"
          echo ""
          echo "=========================================="
          echo "  FUND DATA"
          echo "=========================================="
          ls -lh data/funds/*.csv 2>/dev/null || echo "No fund files"
          echo ""
          echo "=========================================="
          echo "  LISTING METADATA"
          echo "=========================================="
          ls -lh data/metadata/*.csv 2>/dev/null || echo "No metadata files"
          echo ""
          echo "=========================================="
          echo "  HÀNG HÓA (vnstock_data)"
          echo "=========================================="
          ls -lh data/commodity/*.csv 2>/dev/null || echo "No commodity files"
          echo ""
          echo "=========================================="
          echo "  KINH TẾ VĨ MÔ (vnstock_data)"
          echo "=========================================="
          ls -lh data/macro/*.csv 2>/dev/null || echo "No macro files"
          echo ""
          echo "=========================================="
          echo "  MARKET INSIGHTS (vnstock_data)"
          echo "=========================================="
          ls -lh data/insights/*.csv 2>/dev/null || echo "No insights files"
          echo ""
          echo "=========================================="
          echo "  TIN TỨC TÀI CHÍNH (vnstock_news)"
          echo "=========================================="
          if [ -d "data/news/$(TZ=Asia/Ho_Chi_Minh date +%Y-%m-%d)" ]; then
            ls -lh data/news/$(TZ=Asia/Ho_Chi_Minh date +%Y-%m-%d)/*.csv 2>/dev/null | wc -l | xargs -I{} echo "{} news files"
          fi
          ls -lh data/news/trending.csv 2>/dev/null || echo "No trending file"
          echo ""
          echo "=========================================="
          echo "  CHỈ BÁO KỸ THUẬT (vnstock_ta)"
          echo "=========================================="
          ls data/ta/indices/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Indices: {} files"
          ls data/ta/stocks/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Stocks: {} files"
          ls -lh data/ta/signals.csv 2>/dev/null || echo "No signals file"
          echo ""
          echo "=========================================="
          echo "  PIPELINE (vnstock_pipeline)"
          echo "=========================================="
          ls data/pipeline/ohlcv/*.csv 2>/dev/null | wc -l | xargs -I{} echo "OHLCV: {} files"
          ls data/pipeline/financials/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Financials: {} files"
          echo ""
          echo "=========================================="
          echo "  INTRADAY (KBS Quote)"
          echo "=========================================="
          ls data/intraday/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Intraday: {} stocks"
          echo ""
          echo "=========================================="
          echo "  COMPANY EXTRA (Reports, Ownership)"
          echo "=========================================="
          ls -lh data/company_reports.csv data/company_ownership.csv data/capital_history.csv data/company_affiliate.csv 2>/dev/null || echo "No company extra files"
          echo ""
          echo "=========================================="
          echo "  TRADING DETAIL (Foreign, Prop, Stats)"
          echo "=========================================="
          ls -lh data/trading/*.csv 2>/dev/null || echo "No trading detail files"
          echo ""
          echo "=========================================="
          echo "  FINANCE EXTRA (VCI notes + MAS)"
          echo "=========================================="
          ls data/financials_extra/notes/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Notes: {} stocks"
          ls data/financials_extra/ratios_detail/*.csv 2>/dev/null | wc -l | xargs -I{} echo "Ratios detail: {} stocks"
          ls -lh data/financials_extra/mas/*.csv 2>/dev/null || echo "No MAS files"

      # ========== COMMIT & PUSH ==========
      - name: Commit and push all data
        if: steps.check_day.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          if git diff --staged --quiet; then
            echo "Không có dữ liệu mới."
          else
            DATE=${{ steps.date.outputs.date }}
            SESSION_LABEL=${{ steps.session.outputs.label }}
            git commit -m "data: dashboard $DATE [$SESSION_LABEL]"
            git push
          fi

      - name: Upload artifacts
        if: steps.check_day.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-data-${{ steps.date.outputs.date }}
          path: data/
          retention-days: 90
